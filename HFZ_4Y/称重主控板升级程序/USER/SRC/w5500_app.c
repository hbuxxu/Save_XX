/****************************************************************************
* ÎÄ¼şÃû:    w5500_app.c
* ÎÄ¼şÀúÊ·:
* °æ±¾ºÅ:    V1.0
* ÈÕÆÚ:      2017.09.29    
* ×÷Õß:      qgk
* ËµÃ÷:      W5500Ó¦ÓÃ²¿·Ö
*****************************************************************************/
/*=============================================================================
*******ĞŞ¸ÄÈÕÖ¾*******
1¡¢ÈÕ    ÆÚ£º
µØ    µã£º
ĞŞ ¸Ä ÈË£º
Ìí¼ÓÄÚÈİ£º
°æ±¾ºÅ:
2¡¢ÈÕ    ÆÚ£º
µØ    µã£º
ĞŞ ¸Ä ÈË£º
Ìí¼ÓÄÚÈİ£º
°æ±¾ºÅ:
================================================================================*/
#include "stm32f10x.h"
#include "W5500.h"
#include "led.h"
#include "stm32f10x.h"
#include "sys_delay.h"
#include "common.h"
#include "stm32f10x_flash.h"
char cMaster_Address=0x02;                                              //³ÆÖØÉè±¸µØÖ·
unsigned char ucW5500_Test_LRC[2];                                 //Ğ£Ñé´æ´¢Çø
unsigned char ucFlash_Rx_Buffer[2048];                             //Êı¾İ»º´æÇø
unsigned char  ucZB_Version[]={'B',2,3,4,5,6,7,8,9,10,11,12,13};   //°æ±¾ºÅ
unsigned  char *ucWip,*ucFip;                                      //FlashÊı¾İ²ÁĞ´»º´æ
u16 wUp_grade=0;                                                   //Éı¼¶½×¶Î
u16 wNumber_Data,wFlash_Page;                                      //Êı¾İ¿éºÅ£¬FlashÒ³Êı
uint32_t uFlashDestination = ApplicationAddress;                   //Ó¦ÓÃ³ÌĞòµØÖ·
uint16_t wPageSize = PAGE_SIZE;                      //FlashÒ³´óĞ¡ 
u16 wLED_Time_Mark=0;                                //LED¶¨Ê±±êÖ¾
u16 wSunPackage;                                     //Òª´«ÊäµÄÊı¾İ¿éÊıÁ¿
uint32_t FflashDestination = ApplicationAddress;     //²ÁĞ´µØÖ·
FLASH_Status WFLASHStatus = FLASH_COMPLETE;          //Flash×´Ì¬±äÁ¿

   /*Ó¦´ğ±äÁ¿¶¨Òå*/
#pragma pack(1)
typedef union
{
	  unsigned char 	ucACK_Data[6];
    struct 
    {
        unsigned char ucOpc[1];          //¹¦ÄÜÂë      
			  u16  uError;                     //´íÎóÂë
        unsigned char ucNull[2];	         //¿ÕÁôÓÃ
        unsigned char ucZero;	             //0
    }
		stACK_Data;
}
unACK_TypeDef;
#pragma pack()
/*Ó¦´ğ±äÁ¿ÖØ¶¨Òå*/
unACK_TypeDef unACK_Answer;
/*******************************************************************************
* º¯ÊıÃû  : FLASH_Read_Word
* Ãè  Êö  : ¶ÁÈ¡ÏàÓ¦µØÖ·ÄÚµÄÊı¾İ
* Êä  Èë  : address Êı¾İµØÖ·
* Êä  ³ö  : ÎŞ
* ·µ»ØÖµ  : ÏàÓ¦µØÖ·ÄÚ´æ´¢µÄÊı¾İ
* Ëµ  Ã÷  : 
*******************************************************************************/
uint32_t FLASH_Read_Word(uint32_t address)	
{
    return(*(__IO uint32_t*)address);
}
/*******************************************************************************
* º¯ÊıÃû  : Load_Net_Parameters
* Ãè  Êö  : ×°ÔØÍøÂç²ÎÊı
* Êä  Èë  : ÎŞ
* Êä  ³ö  : ÎŞ
* ·µ»ØÖµ  : ÎŞ
* Ëµ  Ã÷  : Íø¹Ø¡¢ÑÚÂë¡¢ÎïÀíµØÖ·¡¢±¾»úIPµØÖ·¡¢¶Ë¿ÚºÅ
*******************************************************************************/
void Load_Net_Parameters(void)
{
		unsigned char 	ucW5500_Id[6];
		#pragma pack(1)
  union 
  {
   unsigned char 	ucW5500_Id[12];
   struct 
   {
   u32 wW5500_Id[3];

   }
   stW5500_Id;
   }uW5500_Id;			
	#pragma pack() 
	uint8_t W5500_Parameter[27];    //ÍøÂçIP²ÎÊı±äÁ¿
	 //IP²ÎÊı¶ÁÈ¡
	SPI_FLASH_BufferRead(W5500_Parameter,20,27);
	 
				uW5500_Id.stW5500_Id.wW5500_Id[0] = *(__IO u32*)(0X1FFFF7E8); 
        uW5500_Id.stW5500_Id.wW5500_Id[1] = *(__IO u32 *)(0X1FFFF7EC); 
        uW5500_Id.stW5500_Id.wW5500_Id[2] = *(__IO u32 *)(0X1FFFF7F0); 
			
			  ucW5500_Id[0]=(unsigned char)((uW5500_Id.stW5500_Id.wW5500_Id[1]&0x0000FF00)>>8);
			  if(ucW5500_Id[0]%2)
				{
		  	ucW5500_Id[0]=ucW5500_Id[0]-1;	
				}
			  ucW5500_Id[1]=(unsigned char)(uW5500_Id.stW5500_Id.wW5500_Id[1]&0x000000FF);
			  ucW5500_Id[2]=(unsigned char)((uW5500_Id.stW5500_Id.wW5500_Id[0]&0xFF000000)>>24);
			  ucW5500_Id[3]=(unsigned char)((uW5500_Id.stW5500_Id.wW5500_Id[0]&0x00FF0000)>>16);
			  ucW5500_Id[4]=(unsigned char)((uW5500_Id.stW5500_Id.wW5500_Id[0]&0x0000FF00)>>8);
			  ucW5500_Id[5]=(unsigned char)(uW5500_Id.stW5500_Id.wW5500_Id[0]&0x000000FF);
				
				Phy_Addr[0]=ucW5500_Id[0];    //¼ÓÔØÎïÀíµØÖ·
        Phy_Addr[1]=ucW5500_Id[1];
        Phy_Addr[2]=ucW5500_Id[2];
        Phy_Addr[3]=ucW5500_Id[3];
        Phy_Addr[4]=ucW5500_Id[4];
        Phy_Addr[5]=ucW5500_Id[5];

        Gateway_IP[0]= W5500_Parameter[0]; //¼ÓÔØÍø¹Ø²ÎÊı
        Gateway_IP[1]= W5500_Parameter[1];
        Gateway_IP[2]= W5500_Parameter[2];
        Gateway_IP[3]= W5500_Parameter[3];
        
        Sub_Mask[0]=W5500_Parameter[4];     //¼ÓÔØ×ÓÍøÑÚÂë
        Sub_Mask[1]=W5500_Parameter[5];
        Sub_Mask[2]=W5500_Parameter[6];
        Sub_Mask[3]=W5500_Parameter[7];


//         Phy_Addr[0]=0x00;    //¼ÓÔØÎïÀíµØÖ·
//         Phy_Addr[1]=0x0C;
//         Phy_Addr[2]=0x29;
//         Phy_Addr[3]=0x7D;
//         Phy_Addr[4]=0x64;
//         Phy_Addr[5]=0x01;
        
				IP_Addr[0]=W5500_Parameter[8];//¼ÓÔØ±¾»úIPµØÖ·   ³ÆÖØ 3
				IP_Addr[1]=W5500_Parameter[9];
				IP_Addr[2]=W5500_Parameter[10];
				IP_Addr[3]=W5500_Parameter[11];
        
        S0_Port[0]=W5500_Parameter[13];   //¼ÓÔØ¶Ë¿Ú0µÄ¶Ë¿ÚºÅ50000 
        S0_Port[1]=W5500_Parameter[12];
   
        S0_Mode=TCP_SERVER;//¼ÓÔØ¶Ë¿Ú0µÄ¹¤×÷Ä£Ê½,TCP¿Í»§¶ËÄ£Ê½
}

/*******************************************************************************
* º¯ÊıÃû  : W5500_Initialization
* Ãè  Êö  : W5500³õÊ¼»¯
* Êä  Èë  : ÎŞ
* Êä  ³ö  : ÎŞ
* ·µ»ØÖµ  : ÎŞ
* Ëµ  Ã÷  : ÎŞ
*******************************************************************************/
void W5500_Initialization(void)
{
    W5500_Init();		  //³õÊ¼»¯W5500¼Ä´æÆ÷º¯Êı
    Detect_Gateway();	//¼ì²éÍø¹Ø·şÎñÆ÷ 
    Socket_Init(0);		//Ö¸¶¨Socket(0~7)³õÊ¼»¯,³õÊ¼»¯¶Ë¿Ú0
    
}
/*******************************************************************************
* º¯ÊıÃû  : W5500_LRC
* Ãè  Êö  : Ğ£ÑéÎ»»ñÈ¡
* Êä  Èë  : *ucData:Êı¾İÊ×µØÖ·£»wLength£ºÊı¾İ³¤¶È
* Êä  ³ö  : ÎŞ
* ·µ»ØÖµ  : Ğ£ÑéÖµ
* Ëµ  Ã÷  : ÎŞ£
*******************************************************************************/
 unsigned char W5500_LRC(unsigned char*ucData,unsigned short wLength)
{
    unsigned char uchLRC=0;
    int i;
    for(i=1;i<wLength;i++)
    {
        uchLRC+=ucData[i];
    }
    return uchLRC;
}
/*******************************************************************************
* º¯ÊıÃû  : W5500_Return_Data
* Ãè  Êö  : »Ø´«Êı¾İ
* Êä  Èë  : ucOrder£ºÃüÁîÂë£»*uc_Data_Buffer£º»Ø´«Êı¾İÊ×µØÖ·£»wSize£ºÊı¾İ³¤¶È
* Êä  ³ö  : ÎŞ
* ·µ»ØÖµ  : ÎŞ
*******************************************************************************/
void W5500_Return_Data(unsigned char ucOrder, unsigned char *uc_Data_Buffer, unsigned short wSize)
{
    unsigned short wSize2,wSize3,wi,wj;
    char cW5500_LRC;
    unsigned char  uc_W5500_Buffer[180];      
    uc_W5500_Buffer[0]=0x02;                
    uc_W5500_Buffer[1]=cMaster_Address|0X80;    
    wSize2=wSize+1;
    wSize3=wSize+3;
    uc_W5500_Buffer[2]=wSize2&0XFF;
    uc_W5500_Buffer[3]=(wSize2>>8)&0XFF;		 
    uc_W5500_Buffer[4]=ucOrder;
    wj=5;
    if(wSize!=0)
    {
        for(wi=0;wi<wSize;wi++,wj++)
        {
            uc_W5500_Buffer[wj]=(*uc_Data_Buffer++);
        }
    }
    wSize3=wSize+5; 
    cW5500_LRC=W5500_LRC(uc_W5500_Buffer,wSize3); 
    uc_W5500_Buffer[wSize+5]=cW5500_LRC;
    wSize2=wSize+6;	 
    uc_W5500_Buffer[wSize2]=0X03;
    wSize2=wSize+7;
    memcpy(W5500_Tx_Buffer, uc_W5500_Buffer, wSize2);
    Write_SOCK_Data_Buffer(0, uc_W5500_Buffer,wSize2);
}


/******************************************************************************
* º¯ÊıÃû  : Process_Socket_Data
* Ãè  Êö  : Ö¸Áî½âÎö
* Êä  Èë  : s:¶Ë¿ÚºÅ
* Êä  ³ö  : ÎŞ
* ·µ»ØÖµ  : ÎŞ
* Ëµ  Ã÷  : Éı¼¶ÃüÁî¡¢Éı¼¶ÇëÇó¡¢Ğ´ÇëÇó½âÎö¡£
*******************************************************************************/
void Process_Socket_Data(SOCKET s)
{
    u16 wNumber_Write;
	  uint32_t *uData_Write;
    unsigned short wSize;
    unsigned char  ucOrder;
    uint32_t *uData_Read=((uint32_t*)(&ucFlash_Rx_Buffer[0]));
    wSize=Read_SOCK_Data_Buffer(s, W5500_Rx_Buffer);
    ucW5500_Test_LRC[0]=W5500_Rx_Buffer[wSize-2];                           
    ucW5500_Test_LRC[1]=W5500_LRC(W5500_Rx_Buffer,wSize-2);   
    if((ucW5500_Test_LRC[0]!=ucW5500_Test_LRC[1])||(W5500_Rx_Buffer[0]!=2)||(W5500_Rx_Buffer[wSize-1]!=3)||(W5500_Rx_Buffer[1]!=cMaster_Address))           //LRCÎ»ÅĞ¶Ï
    {
        W5500_Return_Data('Z', ucZB_Version, 0); 
    }
    else
    {
        ucOrder=W5500_Rx_Buffer[4];
			 if((ucOrder=='B')||(ucOrder=='W'))
			 {
        switch(ucOrder)
        {
            case'B':                                                         //»ñÈ¡°æ±¾ĞÅÏ¢Ö¸Áî                                                               
            {
               W5500_Return_Data('B',ucZB_Version,13);
            }
            break;
            case'W':                                                         //Éı¼¶ÃüÁî
            {
                ucOrder=W5500_Rx_Buffer[5];
                switch(ucOrder)
                {
									case'G':                                                 //ÖØĞÂÉı¼¶ÃüÇëÇó
                    {
											      FLASH_Lock();
                            unACK_Answer.ucACK_Data[0]='G';
                            W5500_Return_Data('W',unACK_Answer.ucACK_Data,1);
											      TimeDelay_ms(10);//ÑÓÊ±10ms
                            NVIC_SystemReset();
                    }
                    break;
									case'W':                                                 //Éı¼¶ÃüÇëÇó
                    {
                        if(wUp_grade==2)
                        {
                            unACK_Answer.ucACK_Data[0]='W';
													  wSunPackage=W5500_Rx_Buffer[7];                                                 //Òª´«ÊäµÄÊı¾İ¿éÊıÁ¿
                            wSunPackage<<=8;
												    wSunPackage+=W5500_Rx_Buffer[6];
													  wSunPackage-=1;       //ÏÂ±ê´Ó0¿ªÊ¼£¬ËùÒÔ¼õ1
													  wUp_grade=4;
                            W5500_Return_Data('W',unACK_Answer.ucACK_Data,1);
                        }
                        else             //E5Á÷³Ì´íÎó
												{
											  unACK_Answer.stACK_Data.ucOpc[0]='E';     
                        unACK_Answer.stACK_Data.uError=5;
                        unACK_Answer.stACK_Data.ucNull[0]=0;
                        unACK_Answer.stACK_Data.ucNull[1]=0;
                        unACK_Answer.stACK_Data.ucZero=0;
                        W5500_Return_Data('W',unACK_Answer.ucACK_Data,3);	
                        }
                    }
                    break;
                    
                    case'D':                                                 //Ğ´Êı¾İ
                    {
                        
                        if(wUp_grade>=4)                                      //²½ÖèÅĞ¶Ï
                        {
                            if(wUp_grade==4)
                            {
															  /*Flash ½âËø*/
                                FLASH_Unlock();
															  FLASH_ClearFlag(FLASH_FLAG_PGERR|FLASH_FLAG_WRPRTERR|FLASH_FLAG_EOP);
                                uData_Write=uData_Read;
                                wUp_grade=5;
                             }
				
                            unACK_Answer.ucACK_Data[1]=W5500_Rx_Buffer[6];
                            unACK_Answer.ucACK_Data[2]=W5500_Rx_Buffer[7];
													 /******************************************************************
                             ********************¿éºÅÒì³£ E4 **********************************
                            ******************************************************************/	
                            if(unACK_Answer.stACK_Data.uError!=wNumber_Data)      //Óë´æ´¢µÄĞ´Èë¿éºÅ¶Ô±È
                            {
                                unACK_Answer.stACK_Data.ucOpc[0]='E';
                                unACK_Answer.stACK_Data.uError=4;
                                unACK_Answer.stACK_Data.ucNull[0]=0;
                                unACK_Answer.stACK_Data.ucNull[1]=0;
                                unACK_Answer.stACK_Data.ucZero=0;
                                W5500_Return_Data('W',unACK_Answer.ucACK_Data,3);	
															  return;
                            }
                            else
                            {
													         if((wSize<522)||(wSunPackage==unACK_Answer.stACK_Data.uError))      //Êı¾İÁ¿Ğ¡ÓÚ512
                                    {
														        if(wSunPackage!=unACK_Answer.stACK_Data.uError)  //²»Îª×îºóÒ»¿éÊı¾İ
																	    {
																	   	unACK_Answer.stACK_Data.ucOpc[0]='E';
                                      unACK_Answer.stACK_Data.uError=2;                //³¤¶ÈÒì³£
                                      unACK_Answer.stACK_Data.ucNull[0]=0;
                                      unACK_Answer.stACK_Data.ucNull[1]=0;
                                      unACK_Answer.stACK_Data.ucZero=0;
                                      W5500_Return_Data('W',unACK_Answer.ucACK_Data,3);	
																	    wUp_grade=7;
																			return;
                                      }
                                     else
                                     {	
                                        ucWip=(&W5500_Rx_Buffer[8]);	    //ĞèÒª¿½±´Êı¾İµÄÊ×µØÖ·
                                        ucFip=((&ucFlash_Rx_Buffer[0])+(wNumber_Data%4)*512);	    //¼ÆËã»º´æÇøµÄµØÖ·
                                        memcpy(ucFip,ucWip,(wSize-10)); 			
                                        while(FLASH_GetFlagStatus(FLASH_FLAG_BSY)==SET)
                                        {
                                            ;
                                        }
                                        WFLASHStatus = FLASH_ErasePage(uFlashDestination + (wPageSize * wFlash_Page));
                                        if(WFLASHStatus!=FLASH_COMPLETE)
																				{
																							  unACK_Answer.stACK_Data.ucOpc[0]='E';
                                                unACK_Answer.stACK_Data.uError=8;                                 //E8²Á³ıÒì³£
                                                unACK_Answer.stACK_Data.ucNull[0]=0;
                                                unACK_Answer.stACK_Data.ucNull[1]=0;
                                                unACK_Answer.stACK_Data.ucZero=0;
                                                W5500_Return_Data('W',unACK_Answer.ucACK_Data,3);	
                                                wUp_grade=7;
																					      return;	
                                         }
                                        uData_Write=uData_Read;
                                        for (wNumber_Write = 0; wNumber_Write <((wSize-10)+wNumber_Data%4*512); wNumber_Write += 4)
                                        {
                                            WFLASHStatus=FLASH_ProgramWord(FflashDestination, *uData_Write);	
                                            if(WFLASHStatus!=FLASH_COMPLETE)
																						{
																							  unACK_Answer.stACK_Data.ucOpc[0]='E';
                                                unACK_Answer.stACK_Data.uError=7;                                 //E7Ğ´ÈëÒì³£
                                                unACK_Answer.stACK_Data.ucNull[0]=0;
                                                unACK_Answer.stACK_Data.ucNull[1]=0;
                                                unACK_Answer.stACK_Data.ucZero=0;
                                                W5500_Return_Data('W',unACK_Answer.ucACK_Data,3);	
                                                wUp_grade=7;
																							  return;
                                               } 
                                            /******************************************************************
                                                              E3  Ğ£¶ÔÒì³£
                                            ******************************************************************/	
                                            if(FLASH_Read_Word(FflashDestination)!=*uData_Write)
                                            {
                                                unACK_Answer.stACK_Data.ucOpc[0]='E';
                                                unACK_Answer.stACK_Data.uError=3;
                                                unACK_Answer.stACK_Data.ucNull[0]=0;
                                                unACK_Answer.stACK_Data.ucNull[1]=0;
                                                unACK_Answer.stACK_Data.ucZero=0;
                                                W5500_Return_Data('W',unACK_Answer.ucACK_Data,3);	
                                                wUp_grade=7;
																							  return;
                                            }	
                                            FflashDestination+=4;
                                            uData_Write+=1;	
                                          } 
																					
																				WFLASHStatus = FLASH_ErasePage(2048*255);      //Çå±êÖ¾Î»£¬Î»ÖÃÄÚÈİ×Ô¼º¶¨Òå¡£
                                        if(WFLASHStatus!=FLASH_COMPLETE)
																				{
																								unACK_Answer.stACK_Data.ucOpc[0]='E';
                                                unACK_Answer.stACK_Data.uError=8;                         //E8²Á³ıÒì³£
                                                unACK_Answer.stACK_Data.ucNull[0]=0;
                                                unACK_Answer.stACK_Data.ucNull[1]=0;
                                                unACK_Answer.stACK_Data.ucZero=0;
                                                W5500_Return_Data('W',unACK_Answer.ucACK_Data,3);	
                                                wUp_grade=7;
																							  return;	
                                         }			
																					
																					
																					
																					
																		wUp_grade=6;				
                                    unACK_Answer.ucACK_Data[0]='D';
                                    unACK_Answer.ucACK_Data[1]=	W5500_Rx_Buffer[6];
                                    unACK_Answer.ucACK_Data[2]=	W5500_Rx_Buffer[7];
                                    W5500_Return_Data('W',unACK_Answer.ucACK_Data,3);	
																	  return;	
                                     }	
                                }	
                                else if(wSize==522)   
                                { 
                                    ucWip=(&W5500_Rx_Buffer[8]);	
                                    ucFip=(&ucFlash_Rx_Buffer[0]+(wNumber_Data%4)*512);	
                                    memcpy(ucFip,ucWip, 512); 	
                                    wNumber_Data+=1;        //½ÓÊÕµ½µÄÊı¾İ°ü´ÎÊı
                                    if(wNumber_Data/4>wFlash_Page)         
                                    {
                                        WFLASHStatus = FLASH_ErasePage(uFlashDestination + (wPageSize * wFlash_Page));
                                        if(WFLASHStatus != FLASH_COMPLETE)
																				{
																							  unACK_Answer.stACK_Data.ucOpc[0]='E';
                                                unACK_Answer.stACK_Data.uError=8;                                 //E8²Á³ıÒì³£
                                                unACK_Answer.stACK_Data.ucNull[0]=0;
                                                unACK_Answer.stACK_Data.ucNull[1]=0;
                                                unACK_Answer.stACK_Data.ucZero=0;
                                                W5500_Return_Data('W',unACK_Answer.ucACK_Data,3);	
                                                wUp_grade=7;
																					      return;	
																				}
                                        wFlash_Page+=1;        //FlashÒ³
                                        /* FlashĞ´Èë*/	
                                        uData_Write=uData_Read;
                                        for (wNumber_Write = 0; wNumber_Write <wPageSize ; wNumber_Write += 4)
                                        { 
                                            WFLASHStatus=FLASH_ProgramWord(FflashDestination, *uData_Write);
                                            if(WFLASHStatus!=FLASH_COMPLETE)
																						{
																							  unACK_Answer.stACK_Data.ucOpc[0]='E';
                                                unACK_Answer.stACK_Data.uError=7;                                 //E7Ğ´ÈëÒì³£
                                                unACK_Answer.stACK_Data.ucNull[0]=0;
                                                unACK_Answer.stACK_Data.ucNull[1]=0;
                                                unACK_Answer.stACK_Data.ucZero=0;
                                                W5500_Return_Data('W',unACK_Answer.ucACK_Data,3);	
                                                wUp_grade=7;
																							  return;	
                                               } 
                                            /******************************************************************
                                                                    ¶ÁĞ´Òì³£
                                            ******************************************************************/		
                                            if(FLASH_Read_Word(FflashDestination)!=*uData_Write)
                                            {
                                                unACK_Answer.stACK_Data.ucOpc[0]='E';
                                                unACK_Answer.stACK_Data.uError=3;
                                                unACK_Answer.stACK_Data.ucNull[0]=0;
                                                unACK_Answer.stACK_Data.ucNull[1]=0;
                                                unACK_Answer.stACK_Data.ucZero=0;
                                                W5500_Return_Data('W',unACK_Answer.ucACK_Data,3);	
																							  wUp_grade=7;
																							  return;	
                                            }								 
                                            FflashDestination+=4;
                                            uData_Write+=1;	
                                        }						
                                    }
                                    unACK_Answer.ucACK_Data[0]='D';
                                    unACK_Answer.ucACK_Data[1]=	W5500_Rx_Buffer[6];
                                    unACK_Answer.ucACK_Data[2]=	W5500_Rx_Buffer[7];
                                    W5500_Return_Data('W',unACK_Answer.ucACK_Data,3);
                                }
                                /******************************************************************
                                                           ³¤¶ÈÒì³£
                                ******************************************************************/	
                                else              //Êı¾İ³¬³ö³¤¶È
                                {
                                    unACK_Answer.stACK_Data.ucOpc[0]='E';
                                    unACK_Answer.stACK_Data.uError=2;
                                    unACK_Answer.stACK_Data.ucNull[0]=0;
                                    unACK_Answer.stACK_Data.ucNull[1]=0;
                                    unACK_Answer.stACK_Data.ucZero=0;
                                    W5500_Return_Data('W',unACK_Answer.ucACK_Data,3);	
																	  wUp_grade=7;
																	  return;
                                }

                            }
                        }
                        else      //Éı¼¶²½Öè´íÎó
												{
												unACK_Answer.stACK_Data.ucOpc[0]='E';     
                        unACK_Answer.stACK_Data.uError=5;
                        unACK_Answer.stACK_Data.ucNull[0]=0;
                        unACK_Answer.stACK_Data.ucNull[1]=0;
                        unACK_Answer.stACK_Data.ucZero=0;
                        W5500_Return_Data('W',unACK_Answer.ucACK_Data,3);	
                        }	
                    }
                    break;
                    default:
                    break;
                }
            }
            break;
            default:
            break;
        }
			  }
				else
				{
          unACK_Answer.stACK_Data.ucOpc[0]='E';
          unACK_Answer.stACK_Data.uError=1;                   //Éı¼¶³ÌĞòÏÂÎŞ·¨Ö´ĞĞÖ¸Áî»Ø¸´
          unACK_Answer.stACK_Data.ucNull[0]=0;
          unACK_Answer.stACK_Data.ucNull[1]=0;
          unACK_Answer.stACK_Data.ucZero=0;
          W5500_Return_Data('W',unACK_Answer.ucACK_Data,3);		

       }
    }
}
/*******************************************************************************
* º¯ÊıÃû  : W5500_DataHandling
* Ãè  Êö  : W5500ÔËĞĞº¯Êı
* Êä  Èë  : ÎŞ
* Êä  ³ö  : ÎŞ
* ·µ»ØÖµ  : ÎŞ
* Ëµ  Ã÷  : W5500Æô¶¯£¬Êı¾İ´¦Àí
*******************************************************************************/
void W5500_DataHandling(void)
{
    if((ucW5500_InitCTR==0)||(ucW5500_InitCTR==1))
    {
        W5500_Hardware_Reset();
    }
    if(ucW5500_InitCTR==2)
    {
        W5500_Initialization();		
        ucW5500_InitCTR=3;
    }
    if(ucW5500_InitCTR==3)
    {
        W5500_Socket_Set();          //W5500¶Ë¿Ú³õÊ¼»¯ÅäÖÃ
        
        if(W5500_Interrupt)          //´¦ÀíW5500ÖĞ¶Ï
        {
            W5500_Interrupt_Process();//W5500ÖĞ¶Ï´¦Àí³ÌĞò¿ò¼Ü
        }
        if((S0_Data & S_RECEIVE) == S_RECEIVE)  //Èç¹ûSocket0½ÓÊÕµ½Êı¾İ
        {
            S0_Data&=~S_RECEIVE;
            Process_Socket_Data(0);              //W5500Êı¾İ´¦Àí
        }
    }
    if(wUp_grade==1)
    {
        if(FLASH_Read_Word(2048 * 255)==0X77777777)   //ÅĞ¶ÏÉı¼¶±êÖ¾   ×Ô¼º¶¨Òå
        {
            wUp_grade=2;
        }
        else
        wUp_grade=6;
    }

}

